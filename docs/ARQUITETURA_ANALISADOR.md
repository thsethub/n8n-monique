# üìê Arquitetura do M√≥dulo Analisador (Refatorado)

## üèóÔ∏è Diagrama de Componentes

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        API Layer (routes.py)                            ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  POST /preprocess  ‚îÄ‚îÄ‚îê                                                 ‚îÇ
‚îÇ  POST /webhook     ‚îÄ‚îÄ‚îº‚îÄ‚îÄ> AnalisadorDeMensagem                        ‚îÇ
‚îÇ                      ‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              AnalisadorPrincipal (Orquestrador)                        ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  async def processar_mensagem():                                       ‚îÇ
‚îÇ    1. Extrair mensagem                                                 ‚îÇ
‚îÇ    2. Validar entrada                                                  ‚îÇ
‚îÇ    3. ‚îÄ‚îÄ> GerenciadorDeCache.obter_do_cache()                        ‚îÇ
‚îÇ    4. ‚îÄ‚îÄ> normalizar_texto()                                          ‚îÇ
‚îÇ    5. ‚îÄ‚îÄ> Classificador.determinar_categoria()                        ‚îÇ
‚îÇ    6. ‚îÄ‚îÄ> ConstrutorDePayload.construir_payload()                     ‚îÇ
‚îÇ    7. ‚îÄ‚îÄ> GerenciadorDeCache.salvar_no_cache()                        ‚îÇ
‚îÇ    8. Retornar resposta completa                                       ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ              ‚îÇ              ‚îÇ              ‚îÇ
           ‚ñº              ‚ñº              ‚ñº              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Normalizador ‚îÇ ‚îÇ Gerenciador  ‚îÇ ‚îÇClassificador ‚îÇ ‚îÇ  Construtor  ‚îÇ
‚îÇ              ‚îÇ ‚îÇ   de Cache   ‚îÇ ‚îÇ              ‚îÇ ‚îÇ  de Payload  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ              ‚îÇ ‚îÇ              ‚îÇ ‚îÇ              ‚îÇ ‚îÇ              ‚îÇ
‚îÇ normalizar_  ‚îÇ ‚îÇ gerar_cache_ ‚îÇ ‚îÇ determinar_  ‚îÇ ‚îÇ construir_   ‚îÇ
‚îÇ texto()      ‚îÇ ‚îÇ key()        ‚îÇ ‚îÇ categoria()  ‚îÇ ‚îÇ payload()    ‚îÇ
‚îÇ              ‚îÇ ‚îÇ              ‚îÇ ‚îÇ              ‚îÇ ‚îÇ              ‚îÇ
‚îÇ @lru_cache   ‚îÇ ‚îÇ obter_do_    ‚îÇ ‚îÇ _e_pergunta_ ‚îÇ ‚îÇ _criar_      ‚îÇ
‚îÇ (512 items)  ‚îÇ ‚îÇ cache()      ‚îÇ ‚îÇ direta()     ‚îÇ ‚îÇ prompts()    ‚îÇ
‚îÇ              ‚îÇ ‚îÇ              ‚îÇ ‚îÇ              ‚îÇ ‚îÇ              ‚îÇ
‚îÇ unidecode()  ‚îÇ ‚îÇ salvar_no_   ‚îÇ ‚îÇ _e_mensagem_ ‚îÇ ‚îÇ _selecionar_ ‚îÇ
‚îÇ              ‚îÇ ‚îÇ cache()      ‚îÇ ‚îÇ complexa()   ‚îÇ ‚îÇ modelo_ia()  ‚îÇ
‚îÇ              ‚îÇ ‚îÇ              ‚îÇ ‚îÇ              ‚îÇ ‚îÇ              ‚îÇ
‚îÇ              ‚îÇ ‚îÇ MD5 hashing  ‚îÇ ‚îÇ Priority:    ‚îÇ ‚îÇ _calcular_   ‚îÇ
‚îÇ              ‚îÇ ‚îÇ              ‚îÇ ‚îÇ 1. system    ‚îÇ ‚îÇ parametros() ‚îÇ
‚îÇ              ‚îÇ ‚îÇ TTLCache     ‚îÇ ‚îÇ 2. messages  ‚îÇ ‚îÇ              ‚îÇ
‚îÇ              ‚îÇ ‚îÇ (1h, 1000)   ‚îÇ ‚îÇ 3. user      ‚îÇ ‚îÇ _obter_      ‚îÇ
‚îÇ              ‚îÇ ‚îÇ              ‚îÇ ‚îÇ              ‚îÇ ‚îÇ historico()  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                           ‚îÇ              ‚îÇ
                                           ‚ñº              ‚ñº
                                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                  ‚îÇ  Detector    ‚îÇ ‚îÇ  Detector    ‚îÇ
                                  ‚îÇ  de Scopes   ‚îÇ ‚îÇ  de Idioma   ‚îÇ
                                  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                                  ‚îÇ              ‚îÇ ‚îÇ              ‚îÇ
                                  ‚îÇ detectar_    ‚îÇ ‚îÇ determinar_  ‚îÇ
                                  ‚îÇ scopes()     ‚îÇ ‚îÇ idioma()     ‚îÇ
                                  ‚îÇ              ‚îÇ ‚îÇ              ‚îÇ
                                  ‚îÇ SCOPE_CACHE  ‚îÇ ‚îÇ Regex:       ‚îÇ
                                  ‚îÇ (8 padr√µes)  ‚îÇ ‚îÇ - PT detect  ‚îÇ
                                  ‚îÇ              ‚îÇ ‚îÇ - EN detect  ‚îÇ
                                  ‚îÇ Scopes:      ‚îÇ ‚îÇ              ‚îÇ
                                  ‚îÇ - gmail      ‚îÇ ‚îÇ Returns:     ‚îÇ
                                  ‚îÇ - calendar   ‚îÇ ‚îÇ - "pt"       ‚îÇ
                                  ‚îÇ - drive      ‚îÇ ‚îÇ - "en"       ‚îÇ
                                  ‚îÇ - sheets     ‚îÇ ‚îÇ              ‚îÇ
                                  ‚îÇ - boleto     ‚îÇ ‚îÇ              ‚îÇ
                                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                           ‚îÇ
                                           ‚ñº
                                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                  ‚îÇ  Constantes  ‚îÇ
                                  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                                  ‚îÇ              ‚îÇ
                                  ‚îÇ PALAVRAS_    ‚îÇ
                                  ‚îÇ CHAVE_DE_    ‚îÇ
                                  ‚îÇ SISTEMA      ‚îÇ
                                  ‚îÇ (44 words)   ‚îÇ
                                  ‚îÇ              ‚îÇ
                                  ‚îÇ SCOPE_CACHE  ‚îÇ
                                  ‚îÇ (8 patterns) ‚îÇ
                                  ‚îÇ              ‚îÇ
                                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîÑ Fluxo de Dados

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       REQUEST FLOW                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. HTTP Request (POST /preprocess)
   ‚îÇ
   ‚îú‚îÄ> payload: {
   ‚îÇ     "message": "enviar email para jo√£o",
   ‚îÇ     "ctx": {"lang": "pt"},
   ‚îÇ     "history": []
   ‚îÇ   }
   ‚îÇ
   ‚ñº
2. AnalisadorPrincipal.__init__(payload)
   ‚îÇ
   ‚îú‚îÄ> self.payload_original = payload
   ‚îú‚îÄ> self.contexto = payload.get("ctx", {})
   ‚îú‚îÄ> self.latencias = {}
   ‚îÇ
   ‚ñº
3. processar_mensagem() [ASYNC]
   ‚îÇ
   ‚îú‚îÄ> [STEP 1] Extrair mensagem
   ‚îÇ   ‚îî‚îÄ> mensagem_usuario = "enviar email para jo√£o"
   ‚îÇ       Lat√™ncia: ~0.0ms
   ‚îÇ
   ‚îú‚îÄ> [STEP 2] Verificar cache
   ‚îÇ   ‚îú‚îÄ> cache_key = MD5(normalize(mensagem))
   ‚îÇ   ‚îî‚îÄ> resultado = GerenciadorDeCache.obter_do_cache(cache_key)
   ‚îÇ       Lat√™ncia: ~0.03-4ms
   ‚îÇ       ‚îî‚îÄ> Se HIT: retorna resultado cacheado (FIM)
   ‚îÇ
   ‚îú‚îÄ> [STEP 3] Normalizar texto
   ‚îÇ   ‚îú‚îÄ> texto_normalizado = normalizar_texto(mensagem)
   ‚îÇ   ‚îî‚îÄ> "enviar email para joao" (sem acento, min√∫sculas)
   ‚îÇ       Lat√™ncia: ~0.0ms (LRU cached)
   ‚îÇ
   ‚îú‚îÄ> [STEP 4] Classificar mensagem
   ‚îÇ   ‚îú‚îÄ> Classificador.determinar_categoria(mensagem, texto_norm)
   ‚îÇ   ‚îú‚îÄ> Verifica PALAVRAS_CHAVE_DE_SISTEMA
   ‚îÇ   ‚îî‚îÄ> categoria = "system", motivos = ["email detectado"]
   ‚îÇ       Lat√™ncia: ~0.01ms
   ‚îÇ
   ‚îú‚îÄ> [STEP 5] Construir payload
   ‚îÇ   ‚îú‚îÄ> ConstrutorDePayload.construir_payload(...)
   ‚îÇ   ‚îú‚îÄ‚îÄ> DetectorDeIdioma.determinar_idioma(mensagem)
   ‚îÇ   ‚îÇ    ‚îî‚îÄ> idioma = "pt"
   ‚îÇ   ‚îú‚îÄ‚îÄ> DetectorDeScopes.detectar_scopes(texto_norm)
   ‚îÇ   ‚îÇ    ‚îú‚îÄ> Busca em SCOPE_CACHE
   ‚îÇ   ‚îÇ    ‚îî‚îÄ> scopes = ["https://mail.google.com/"]
   ‚îÇ   ‚îú‚îÄ‚îÄ> _criar_prompts_de_sistema(categoria, idioma, scopes)
   ‚îÇ   ‚îú‚îÄ‚îÄ> _selecionar_modelo_ia(categoria)
   ‚îÇ   ‚îÇ    ‚îî‚îÄ> modelo = "gpt-4.1-mini"
   ‚îÇ   ‚îú‚îÄ‚îÄ> _calcular_parametros_da_ia(categoria)
   ‚îÇ   ‚îÇ    ‚îî‚îÄ> {temperature: 0.3, max_tokens: 900}
   ‚îÇ   ‚îî‚îÄ‚îÄ> payload_openai = {model, messages, temperature, max_tokens}
   ‚îÇ       Lat√™ncia: ~0.01ms
   ‚îÇ
   ‚îú‚îÄ> [STEP 6] Salvar no cache
   ‚îÇ   ‚îî‚îÄ> GerenciadorDeCache.salvar_no_cache(cache_key, resposta)
   ‚îÇ
   ‚ñº
4. Retornar resposta completa
   ‚îÇ
   ‚îî‚îÄ> {
         "mensagem_completa": "enviar email para jo√£o",
         "texto_normalizado": "enviar email para joao",
         "openaiPayload": {...},
         "classification": {
           "bucket": "system",
           "reasons": [...],
           "scope": ["https://mail.google.com/"]
         },
         "performance": {
           "extracao_ms": 0.0,
           "cache_lookup_ms": 0.03,
           "normalizacao_ms": 0.0,
           "classificacao_ms": 0.01,
           "construcao_payload_ms": 0.01,
           "total_ms": 0.06
         }
       }
```

## üß© Depend√™ncias Entre M√≥dulos

```
AnalisadorPrincipal
    ‚îú‚îÄ‚îÄ usa ‚Üí Normalizador
    ‚îÇ   ‚îî‚îÄ‚îÄ depende de: unidecode, functools.lru_cache
    ‚îÇ
    ‚îú‚îÄ‚îÄ usa ‚Üí GerenciadorDeCache
    ‚îÇ   ‚îî‚îÄ‚îÄ depende de: hashlib, app.core.metrics, app.core.config
    ‚îÇ
    ‚îú‚îÄ‚îÄ usa ‚Üí Classificador
    ‚îÇ   ‚îú‚îÄ‚îÄ depende de: app.utils.regex (7 patterns)
    ‚îÇ   ‚îî‚îÄ‚îÄ depende de: Constantes (PALAVRAS_CHAVE_DE_SISTEMA)
    ‚îÇ
    ‚îî‚îÄ‚îÄ usa ‚Üí ConstrutorDePayload
        ‚îú‚îÄ‚îÄ usa ‚Üí DetectorDeIdioma
        ‚îÇ   ‚îî‚îÄ‚îÄ depende de: app.utils.regex (3 patterns)
        ‚îÇ
        ‚îú‚îÄ‚îÄ usa ‚Üí DetectorDeScopes
        ‚îÇ   ‚îî‚îÄ‚îÄ depende de: Constantes (SCOPE_CACHE)
        ‚îÇ
        ‚îî‚îÄ‚îÄ depende de: contexto, payload_original

Constantes
    ‚îî‚îÄ‚îÄ independente (apenas dados est√°ticos)

Normalizador
    ‚îî‚îÄ‚îÄ independente (apenas unidecode)
```

## üìä Matriz de Responsabilidades

| M√≥dulo                | Responsabilidade Principal | LOC | Depend√™ncias |
|-----------------------|---------------------------|-----|--------------|
| **analisador_principal** | Orquestra√ß√£o do fluxo | 124 | 5 m√≥dulos |
| **classificador**     | Categoriza√ß√£o de mensagens | 89 | 2 m√≥dulos |
| **construtor_payload** | Montagem payload OpenAI | 149 | 3 m√≥dulos |
| **detector_scopes**   | Detec√ß√£o de integra√ß√µes | 101 | 1 m√≥dulo |
| **detector_idioma**   | Detec√ß√£o de idioma | 22 | 1 m√≥dulo |
| **gerenciador_cache** | Opera√ß√µes de cache | 58 | 3 m√≥dulos |
| **normalizador**      | Normaliza√ß√£o de texto | 24 | 1 pacote |
| **constantes**        | Dados est√°ticos | 54 | 0 |
| **TOTAL**             | - | **621** | - |

## üéØ Padr√µes de Design Aplicados

### 1. **Single Responsibility Principle (SRP)**
Cada m√≥dulo tem uma responsabilidade √∫nica e bem definida.

### 2. **Dependency Injection**
`ConstrutorDePayload` recebe contexto e payload via construtor.

### 3. **Strategy Pattern**
Sele√ß√£o de modelo e par√¢metros baseada na categoria.

### 4. **Facade Pattern**
`AnalisadorPrincipal` √© a fachada que orquestra todos os componentes.

### 5. **Cache Pattern**
- LRU cache para normaliza√ß√£o (hot path)
- TTL cache para resultados completos

### 6. **Factory Pattern**
`ConstrutorDePayload` cria diferentes payloads baseado em categoria.

## üöÄ Pontos de Extens√£o

### Adicionar Nova Categoria
```python
# Em classificador.py
def determinar_categoria(...):
    # ... l√≥gica existente ...
    
    # NOVA CATEGORIA
    if self._e_mensagem_tecnica(texto_normalizado):
        return "technical", ["Mensagem t√©cnica detectada"]
```

### Adicionar Novo Scope
```python
# Em constantes.py
SCOPE_CACHE: Dict[str, List[str]] = {
    # ... scopes existentes ...
    
    # NOVO SCOPE
    "criar tarefa": ["https://www.googleapis.com/auth/tasks"],
}
```

### Adicionar Novo Detector
```python
# Criar detector_sentimento.py
class DetectorDeSentimento:
    @staticmethod
    def detectar_sentimento(texto: str) -> str:
        # ... l√≥gica de detec√ß√£o ...
        return "positivo"  # ou "negativo", "neutro"

# Importar em construtor_payload.py
from .detector_sentimento import DetectorDeSentimento
```

## üìà M√©tricas de Qualidade

### Complexidade Ciclom√°tica (por m√≥dulo)
- **analisador_principal**: 6 (Baixa)
- **classificador**: 8 (M√©dia)
- **construtor_payload**: 10 (M√©dia)
- **detector_scopes**: 12 (M√©dia-Alta)
- **detector_idioma**: 3 (Muito Baixa)
- **gerenciador_cache**: 4 (Baixa)
- **normalizador**: 2 (Muito Baixa)
- **constantes**: 1 (Muito Baixa)

### Coes√£o
‚úÖ **Alta**: Cada m√≥dulo tem m√©todos relacionados a uma √∫nica responsabilidade

### Acoplamento
‚úÖ **Baixo**: M√≥dulos dependem de interfaces, n√£o de implementa√ß√µes concretas

---

**Legenda do Diagrama**:
- `‚îÄ‚îÄ>` : Fluxo de dados
- `‚îî‚îÄ‚îÄ>` : Depend√™ncia/chamada de m√©todo
- `[STEP N]` : Etapa numerada do processamento
- `~Xms` : Lat√™ncia m√©dia em milissegundos
